# Setup Guide

This project uses Postgres + Alembic for schema, and a Next.js frontend.

---

# üìç LOCAL DEVELOPMENT

## 1) Prerequisites

- Python 3.11+
- Node.js 18+
- PostgreSQL 13+ (or use Supabase connection)

## 2) Create Local Database

### Option A: Local PostgreSQL

```sql
CREATE DATABASE interviewprep;
```

### Option B: Use Supabase (recommended)

Use the **Session Pooler** URL for local development (supports IPv4):

```
postgresql://postgres.[project-ref]:[password]@aws-0-[region].pooler.supabase.com:5432/postgres
```

## 3) Configure Backend Environment

Create `backend/.env`:

```env
# Required
ENV=dev
SECRET_KEY=your_secret_key_here
DATABASE_URL=postgresql+psycopg2://USER:PASSWORD@localhost:5432/interviewprep

# For Supabase, use:
# DATABASE_URL=postgresql+psycopg2://postgres.[ref]:[password]@aws-0-[region].pooler.supabase.com:5432/postgres

# Optional but recommended
DEEPSEEK_API_KEY=your_deepseek_key
SENDGRID_API_KEY=your_sendgrid_key
FROM_EMAIL=noreply@yourdomain.com
```

## 4) Install Dependencies

### Backend

```bash
cd backend
python -m venv .venv

# Windows
.venv\Scripts\activate

# Mac/Linux
source .venv/bin/activate

pip install -r requirements.txt
```

### Frontend

```bash
cd frontend-next
npm install
```

## 5) Run Migrations

```bash
cd backend
alembic upgrade head
```

## 6) Seed Questions

```bash
cd backend
python seed.py --questions
```

Or run migrations + seed together:

```bash
python seed.py
```

## 7) Create Test Admin User

```bash
cd backend
python create_test_user.py
python make_admin.py test@example.com
```

## 8) Start Development Servers

### Backend (Terminal 1)

```bash
cd backend
uvicorn app.main:app --reload
```

### Frontend (Terminal 2)

```bash
cd frontend-next
npm run dev
```

### Access

- Frontend: http://localhost:3000
- Backend API: http://localhost:8000
- API Docs: http://localhost:8000/docs

---

# üöÄ PRODUCTION (Render + Supabase)

## Environment Variables (Render Dashboard)

| Variable                  | Value                       |
| ------------------------- | --------------------------- |
| `ENV`                     | `production`                |
| `SECRET_KEY`              | Auto-generated by Render    |
| `DATABASE_URL`            | Supabase Session Pooler URL |
| `DEEPSEEK_API_KEY`        | Your DeepSeek API key       |
| `SENDGRID_API_KEY`        | Your SendGrid API key       |
| `FROM_EMAIL`              | Your verified sender email  |
| `SEED_QUESTIONS_ON_START` | `true`                      |

## Supabase Connection String

‚ö†Ô∏è **Use Session Pooler** (not Direct) for Render free tier:

```
postgresql://postgres.[project-ref]:[password]@aws-0-[region].pooler.supabase.com:5432/postgres
```

Direct connection (IPv6) does NOT work on Render free tier.

## Automatic Deployment

On every `git push` to `main`:

1. Render rebuilds and deploys
2. Alembic runs migrations (`alembic upgrade head`)
3. Test admin user is created
4. Questions seed if database is empty

---

# üóÑÔ∏è DATABASE COMMANDS (Supabase SQL Editor)

## View Data

```sql
-- Count all questions
SELECT COUNT(*) FROM questions;

-- View all users
SELECT id, email, is_admin, is_banned, is_verified, created_at FROM users;

-- View recent audit logs
SELECT * FROM audit_logs ORDER BY created_at DESC LIMIT 20;
```

## Re-seed Questions (After Updating JSON Files)

**Step 1:** Truncate questions table

```sql
TRUNCATE questions CASCADE;
```

**Step 2:** Redeploy backend in Render (Manual Deploy)

Questions will automatically re-seed because the table is now empty.

## Backup Before Truncating

```sql
-- Create backup
CREATE TABLE questions_backup AS SELECT * FROM questions;

-- Verify backup
SELECT COUNT(*) FROM questions_backup;
```

## Restore from Backup

```sql
-- Clear current questions
TRUNCATE questions CASCADE;

-- Restore from backup
INSERT INTO questions SELECT * FROM questions_backup;

-- Drop backup table when done
DROP TABLE questions_backup;
```

## Full Database Backup

```sql
-- Create backups of all important tables
CREATE TABLE users_backup AS SELECT * FROM users;
CREATE TABLE questions_backup AS SELECT * FROM questions;
CREATE TABLE interview_sessions_backup AS SELECT * FROM interview_sessions;
CREATE TABLE messages_backup AS SELECT * FROM messages;
CREATE TABLE audit_logs_backup AS SELECT * FROM audit_logs;
```

## Reset Specific Tables

```sql
-- Reset interview sessions (keeps users and questions)
TRUNCATE interview_sessions CASCADE;

-- Reset audit logs
TRUNCATE audit_logs;

-- Reset all user data (keeps questions)
TRUNCATE users CASCADE;
```

## ‚ö†Ô∏è DANGER: Full Database Reset

```sql
-- This deletes EVERYTHING - use with extreme caution!
TRUNCATE users, questions, interview_sessions, messages, audit_logs CASCADE;
```

After this, redeploy to re-seed questions and recreate test admin.

---

# üë§ ADMIN MANAGEMENT

## Make User an Admin (Supabase)

```sql
-- Make specific user admin
UPDATE users SET is_admin = true WHERE email = 'your@email.com';

-- Verify
SELECT email, is_admin FROM users WHERE is_admin = true;
```

## Remove Admin Access

```sql
UPDATE users SET is_admin = false WHERE email = 'user@email.com';
```

## Unban a User

```sql
UPDATE users
SET is_banned = false, ban_reason = NULL, banned_at = NULL
WHERE email = 'user@email.com';
```

## Ban a User

```sql
UPDATE users
SET is_banned = true, ban_reason = 'Reason here', banned_at = NOW()
WHERE email = 'user@email.com';
```

## Verify a User Manually

```sql
UPDATE users SET is_verified = true WHERE email = 'user@email.com';
```

---

# üîß TROUBLESHOOTING

## Connection Issues

| Error                            | Solution                           |
| -------------------------------- | ---------------------------------- |
| `Network is unreachable`         | Use Session Pooler URL, not Direct |
| `password authentication failed` | Check password in DATABASE_URL     |
| `relation does not exist`        | Run `alembic upgrade head`         |

## Render Deploy Issues

1. Check **Render Logs** for errors
2. Verify all environment variables are set
3. Try **Manual Deploy** ‚Üí "Clear build cache & deploy"

## Questions Not Seeding

1. Check if questions already exist: `SELECT COUNT(*) FROM questions;`
2. If > 0, truncate first: `TRUNCATE questions CASCADE;`
3. Redeploy

## Admin Can't Access Dashboard

1. Verify user is admin: `SELECT email, is_admin FROM users WHERE email = '...';`
2. If not, set admin: `UPDATE users SET is_admin = true WHERE email = '...';`

---

# üìã QUICK REFERENCE

| Task             | Command/Action                                                     |
| ---------------- | ------------------------------------------------------------------ |
| Update questions | Edit JSON ‚Üí Truncate ‚Üí Redeploy                                    |
| Add new admin    | Supabase: `UPDATE users SET is_admin = true WHERE email = '...'`   |
| Unban user       | Supabase: `UPDATE users SET is_banned = false WHERE email = '...'` |
| Check logs       | Render Dashboard ‚Üí Logs                                            |
| Manual deploy    | Render Dashboard ‚Üí Manual Deploy                                   |
| View tables      | Supabase ‚Üí Table Editor                                            |
| Run SQL          | Supabase ‚Üí SQL Editor                                              |

---

# üîê INITIAL ADMIN CREDENTIALS

After fresh deploy:

- **Email:** `test@example.com`
- **Password:** `password123`
- **Login URL:** `/login`
- **Admin Panel:** `/admin/dashboard`

‚ö†Ô∏è **Recommended:** Create your own admin account, then ban or delete the test account.
